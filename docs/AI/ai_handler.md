<h1 align="center"> AI Handler for Applications repositories </h1>

## Description
For application repositories, we have implemented a solution that works with pull request comments requests. Depending on the comments we have several actions for AI:

1) unit tests generation
2) code explanation
3) code coverage by comments

## Workflow:

PR Comment in a specific format → GitHub webhook triggered by ISSUE_COMMENT event → Lambda as a front door of the request → CodeBuild as a main handler and communicator with AI → output in PR comments (by default) or as a new PR

## Diagram

![Workflow_diagram](../AI/pic/ai_handler/workflow_diagram.png)

## Terraform module
There is Terraform module [ai_handler](../../modules/accelerator/ai_handler) for this solution.

You can deploy it by setting variable `ai_handler_create = true` in [env.hcl](../../terragrunt-infrastructure-example/accelerator/accounts/accelerator/regions/example/setup_folder/applications/example/env.hcl) file, when you do initial setup for application CI/CD and deploy [setup_folder](../../terragrunt-infrastructure-example/accelerator/accounts/accelerator/regions/example/setup_folder)

![enable_variable](../AI/pic/ai_handler/enable_variable.png)


## Webhook
Webhook URL is a URL of Lambda function. Webhook and its settings are created automatically once the terraform code deployed

![Webhook](../AI/pic/ai_handler/webhook_url.png)

We react on **ISSUE_COMMENT** event only

![Webhook_event](../AI/pic/ai_handler/webhook_event.png)

# **Infrastructure**
## Lambda

Lambda is the main point to receive a payload of GitHub webhook. Parse it, detect a keyword we check to start AI handler, and check action type (unit test, code explanation, comment coverage). Detect repository parameters: PR number, owner of the repository, repository name, and whether we create a new PR with results or not. It has several main options

### Layer

It contains a request Python module because it doesn't support Lambda by default. An additional layer is a workaround on how to install it

![Layer](../AI/pic/ai_handler/lambda_layer.png)

The Terraform module has a zip file with this Layer we deploy along with the Terraform code.

The Layer contains the Request Python module zip file which is not available in Lambda by default.

![Request_python_module](../AI/pic/ai_handler/python.zip.png)


### Environment variables

CodeBuild name and GitHub Token

![Codebuild_env_var](../AI/pic/ai_handler/codebuild_env_var.png)

### Python code

It resides in the terraform code and is deployed by terraform

![Python_code](../AI/pic/ai_handler/lambda_tf.png)

### Runtime

As Python 3.11

![Python_code](../AI/pic/ai_handler/lambda_runtime.png)

### Enabled Function URL

We use it as a front door to trigger the Lambda function by a webhook from GitHub

![Lambda_URL](../AI/pic/ai_handler/lambda_url.png)

## CodeBuild

If the condition of a comment in a PR is met our conditions, it triggers a CodeBuild, which executes AI handler script [ai_cicd_analyzer.py](../../docs/template_config_files/scripts/ai/ai_cicd_analyzer.py).

- [**buildspec_with_ai.yml**](../../docs/template_config_files/buildspec_with_ai.yml) should be copied to the application repository.


## Python code

As a step of codebuild we must run our AI script
```
build:
  commands:
    - python ${CODEBUILD_SRC_DIR}/scripts/ai/ai_cicd_analyzer.py
```

Source code also exists in the Infra repository for reference but in the target application repository it should be placed manually in the folder scripts/ai together with requirements.txt in the scripts folder



## Environment variables

They passed by Lambda directly

![Codebuild_env_var](../AI/pic/ai_handler/codebuild_env_var.png)

## Source of CodeBuild

An important step to force it to work properly. Settings deployed by Terraform code.

![Source_codebuild](../AI/pic/ai_handler/codebuild_source.png)

## Results
Call for a Help Menu

![Help_menu](../AI/pic/ai_handler/help_menu.png)
![Help_menu](../AI/pic/ai_handler/help_menu_2.png)
![Help_menu](../AI/pic/ai_handler/help_menu_3.png)

## Unit test generation

![Unit_test_result](../AI/pic/ai_handler/unit_test_result.png)

## Code explanation

![Code_explanation_result](../AI/pic/ai_handler/doc_results.png)

## Code coverage by comments

![Comments](../AI/pic/ai_handler/comment_results.png)


## Wrong file path or name

![Wrong_file_name](../AI/pic/ai_handler/no_file.png)

## With pull request option (for comments and unit tests only)
![PR](../AI/pic/ai_handler/pr_option.png)

![Files_changed](../AI/pic/ai_handler/files_changed.png)

## If the branch generated by AI already exists

![Branch_exist](../AI/pic/ai_handler/branch_exist.png)
